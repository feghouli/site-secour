<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ูุฏูุฑูุฉ ุงูุชุฑุจูุฉ ูููุงูุฉ ุชููุฑุช</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- ููุชุจุงุช -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #6a11cb, #2575fc);
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh; padding: 15px; overflow-x: hidden;
    }

    /* ====== ุชุตููู ุงููุงุฌูุฉ (ูุจู ุงูุชุญูู) ====== */
    .container {
      position: relative; background: white;
      padding: 35px 40px 10px;
      border-radius: 18px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.2);
      text-align: center; width: 100%; max-width: 500px;
      margin: 0 auto;
    }

    .page-header {
      text-align: center;
      margin-bottom: 25px;
    }

    .page-header .header-logo {
      width: 250px;
      height: auto;
      display: block;
      margin: 0 auto 0px auto;
      filter: contrast(1.05) brightness(1.1);
      animation: pulseLogo 2.5s ease-in-out infinite;
    }

    @keyframes pulseLogo {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.08); }
    }

    .header-text {
      font-size: 20px;
      font-weight: 600;
      line-height: 1.5;
      color: #444;
      margin-bottom: 10px;
    }

    .gradient-title {
      font-size: 20px;
      font-weight: 600;
      background: linear-gradient(to right, #6a11cb, #2575fc);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-top: 0px;
      margin-bottom: 15px;
      display: inline-block;
      position: relative;
    }

    .gradient-title::after {
      content: "";
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(to right, #6a11cb, #2575fc);
      border-radius: 2px;
    }

    /* ====== ุนูุงุตุฑ ุงูุฅุฏุฎุงู (ูุงุฌูุฉ ุงูุชุญูู ููุท) ====== */
    input, select, textarea {
      width: 100%; padding: 12px 14px; margin-bottom: 12px;
      border-radius: 8px; border: 2px solid #e0e0e0;
      font-size: 14px; text-align: center;
      font-family: 'Cairo', sans-serif; font-weight: 500;
    }

    input[readonly] { background:#f5f5f5; }

    input:focus, select:focus {
      outline: none;
      border-color: #2575fc;
    }

    button {
      background: linear-gradient(45deg, #6a11cb, #2575fc);
      color: white; border: none;
      padding: 14px 0; border-radius: 10px;
      font-size: 15px; cursor: pointer;
      font-weight: 600; width: 100%;
      font-family: 'Cairo', sans-serif;
    }

    .small-note { font-size:12px; color:#666; margin-bottom:8px; text-align:center; }

    /* ====== ุชูุณูู ุชุฌุงูุจ ุงูููุงุชู ====== */
    @media (max-width: 600px) {
      .container {
        padding: 25px 20px 15px;
        border-radius: 14px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      }

      .page-header .header-logo {
        width: 120px;
      }

      .gradient-title {
        font-size: 20px;
        margin-top: 20px;
      }

      input, select, button {
        font-size: 14px;
        padding: 12px;
      }
    }

/* ====== ุชูุณูู ุงูุงุณุชูุงุฑุฉ ====== */
#registrationForm {
  text-align: center;
}

form label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: #333;
  margin-bottom: 5px;
}

input, select, textarea {
  width: 100%;
  padding: 12px 14px;
  margin-bottom: 12px;
  border-radius: 8px;
  border: 2px solid #e0e0e0;
  font-size: 14px;
  text-align: center;
  font-family: 'Cairo', sans-serif;
  font-weight: 500;
}

input[readonly] {
  background: #f5f5f5;
}

input:focus, select:focus {
  outline: none;
  border-color: #2575fc;
}

button {
  background: linear-gradient(45deg, #6a11cb, #2575fc);
  color: white;
  border: none;
  padding: 14px 0;
  border-radius: 10px;
  font-size: 15px;
  cursor: pointer;
  font-weight: 600;
  width: 100%;
  font-family: 'Cairo', sans-serif;
}

.row {
  display: flex;
  gap: 12px;
  margin-bottom: 10px;
}

.col {
  flex: 1;
}

@media (max-width: 680px) {
  .row { flex-direction: column; }
}

/* ====== ุชูุณูู ุฎุงุต ูุญููู ุฃุฑูุงู ุงูููุงุชู ====== */
#phoneDirectorField::placeholder,
#phoneFinancialField::placeholder {
  text-align: center;
  direction: rtl;
}

#phoneDirectorField,
#phoneFinancialField {
  text-align: center;
  direction: ltr;
}

  </style>
</head>

<body>
  <div class="container" id="mainContainer">
    <div class="page-header">
     
      <div class="header-text">
        ุงูุฌูููุฑูุฉ ุงูุฌุฒุงุฆุฑูุฉ ุงูุฏูููุฑุงุทูุฉ ุงูุดุนุจูุฉ<br>
        ูุฒุงุฑุฉ ุงูุชุฑุจูุฉ ุงููุทููุฉ<br>
        ูุฏูุฑูุฉ ุงูุชุฑุจูุฉ ูููุงูุฉ ุชููุฑุช
      </div>
 <img src="https://lh3.googleusercontent.com/d/1BqWoqh1T1lArUcwAGNF7cGnnN83niKVl" alt="ุดุนุงุฑ ุงููุฌูุฉ" class="header-logo">
      <h2 class="gradient-title">ุจูุงุจุฉ ูุตูุญุฉ ุชุณููุฑ ูููุงุช ุงููุณุชุฎุฏููู</h2>
      <input type="text" id="empId" placeholder="ุฃุฏุฎู ุฑูู ุงูุชุนุฑูู ุงููุธููู ุงูุฎุงุต ุจุงููุฏูุฑ ุฃู ุงููููู" oninput="validateNumber(this)">
      <button onclick="checkEmployee()">ุชุณุฌูู ุงูุฏุฎูู</button>
    </div>
  </div>

<!-- โ ูุณู ุงูุงุณุชูุงุฑุฉ -->
<div id="registrationForm" style="display:none; margin-top:25px;">

  <form id="empForm">
    
    <!-- ุงูุตู 1 -->
    <div class="row">
      <div class="col">
        <label for="empIdField">ุฑูู ุงูุชุนุฑูู ุงููุธููู</label>
        <input type="text" id="empIdField" name="empId" readonly>
      </div>
      <div class="col">
        <label for="fullName">ุงูุงุณู ุงููุงูู</label>
        <input type="text" id="fullName" name="fullName" required>
      </div>
    </div>

    <!-- ุงูุตู 2 -->
    <div class="row">
      <div class="col">
        <label for="rank">ุงูุฑุชุจุฉ</label>
        <input type="text" id="rank" name="rank" required>
      </div>
      <div class="col">
        <label for="workPlace">ููุงู ุงูุนูู</label>
        <input type="text" id="workPlace" name="workPlace" required>
      </div>
    </div>

    <!-- ุงูุตู 3 -->
    <div class="row">
      <div class="col">
        <label for="position">ุงูุตูุฉ</label>
        <input type="text" id="position" name="position" required>
      </div>
      <div class="col">
        <label for="level">ุงูุทูุฑ</label>
        <input type="text" id="level" name="level" required>
      </div>
    </div>

    <!-- ุงูุตู 4 -->
    <div class="row">
      <div class="col">
        <label for="district">ุงูุฏุงุฆุฑุฉ</label>
        <input type="text" id="district" name="district" required>
      </div>
      <div class="col">
        <label for="municipality">ุงูุจูุฏูุฉ</label>
        <input type="text" id="municipality" name="municipality" required>
      </div>
    </div>

    <!-- ุงูุตู 5 -->
    <div class="row">
      <div class="col">
        <label for="schoolName">ุงุณู ุงููุชูุณุทุฉ</label>
        <input type="text" id="schoolName" name="schoolName" required>
      </div>
      <div class="col">
        <label for="code">ุงูุฑูุฒ</label>
        <input type="text" id="code" name="code" required>
      </div>
    </div>

    <!-- ุงูุตู 6 -->
    <div class="row">
      <div class="col">
        <label for="email">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
        <input type="email" id="email" name="email" required>
      </div>
      <div class="col">
        <label for="managerPhone">ุฑูู ูุงุชู ุงููุฏูุฑ</label>
        <input type="tel" id="managerPhone" name="managerPhone" required>
      </div>
    </div>

    <!-- ุงูุตู 7 -->
    <div class="row">
      <div class="col">
        <label for="finName">ุงูุงุณู ุงููุงูู ูููุณูุฑ ุงููุงูู</label>
        <input type="text" id="finName" name="finName" required>
      </div>
      <div class="col">
        <label for="finPhone">ุฑูู ูุงุชู ุงููุณูุฑ ุงููุงูู</label>
        <input type="tel" id="finPhone" name="finPhone" required>
      </div>
    </div>

    <button type="submit">ุชุฃููุฏ ุงูุชุณุฌูู</button>
  </form>
</div>



<script>
const firebaseConfig = {
  apiKey: "AIzaSyBNBrVpBK8p_WWNwNhSH-mZ6NXOyr2TLhI",
  authDomain: "voyage-touggourt-48755.firebaseapp.com",
  projectId: "voyage-touggourt-48755",
  storageBucket: "voyage-touggourt-48755.firebasestorage.app",
  messagingSenderId: "712694455348",
  appId: "1:712694455348:web:5b4e8df57347edf944fe61",
  measurementId: "G-TTJT4LQ65L"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const scriptURL = "https://script.google.com/macros/s/AKfycby0FKUinapsx0LlnG2BkcsOUMr4ZNd6Iw6cAc5Q4qmsb3Lf-uDw6MHJREKtCwbRSYY/exec";







function validateNumber(input) {
  input.value = input.value.replace(/\D/g, '');
  if (input.value.length > 16) input.value = input.value.slice(0, 16);
}

async function checkEmployee() {
  const empId = document.getElementById("empId").value.trim();

  if (empId.length < 16) {
    Swal.fire({ icon: 'warning', title: 'ุฎุทุฃ', text: 'ุฑูู ุงูุชุนุฑูู ุงููุธููู ูุฌุจ ุฃู ูุชููู ูู 16 ุฑูููุง' });
    return;
  }

  Swal.fire({ title: 'ุฌุงุฑู ุงูุชุญูู...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

  try {
    const docRef = db.collection("employees").doc(empId);
    const docSnap = await docRef.get();

    if (!docSnap.exists) {
      Swal.close();
      Swal.fire("โ ุฎุทุฃ", "ุฑูู ุงูููุธู ุบูุฑ ููุฌูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช", "error");
      return;
    }

    const data = docSnap.data();

    // โ ุงูุชุญูู ูู ูุฌูุฏ ุชุณุฌูู ุณุงุจู ูุจู ุนุฑุถ ุงูุงุณุชูุงุฑุฉ
    const params = new URLSearchParams();
    params.append("action", "check_existing");
    params.append("empId", empId);

    try {
      const res = await fetch(scriptURL, {
        method: "POST",
        body: params
      });
      const result = await res.json();

      Swal.close();

      if (result.result === "exists") {
        const d = result.data || {};
        const currentWorkLine = (d.role === "ูุฏูุฑ ูููู" && d.currentWork)
          ? `<b>ูุคุณุณุฉ ุงูุนูู ุงูุญุงููุฉ:</b> ${d.currentWork}<br>` : "";

        Swal.fire({
          title: "โ๏ธ ุงูุชุณุฌูู ููุฌูุฏ ูุณุจููุง",
          html: `
            <div style="text-align:right;direction:rtl;font-family:'Cairo',sans-serif;">
              <b>ุฑูู ุงูุชุนุฑูู:</b> ${d.empId || ''}<br>
              <b>ุงูุงุณู ูุงูููุจ:</b> ${d.name || ''}<br>
              <b>ุงูุฑุชุจุฉ:</b> ${d.grade || ''}<br>
              <b>ูุคุณุณุฉ ุงูุนูู ุงูุฃุตููุฉ:</b> ${d.place || ''}<br>
              <b>ุงูุตูุฉ:</b> ${d.role || ''}<br>
              ${currentWorkLine}
              <b>ุงูุทูุฑ:</b> ${d.level || ''}<br>
              <b>ุงูุฏุงุฆุฑุฉ:</b> ${d.daira || ''}<br>
              <b>ุงูุจูุฏูุฉ:</b> ${d.baladiya || ''}<br>
              <b>ุงุณู ุงููุคุณุณุฉ:</b> ${d.school || ''}<br>
              <b>ุฑูุฒ ุงููุคุณุณุฉ:</b> ${d.schoolCode || ''}<br>
              <b>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู:</b> ${d.email || ''}<br>
              <b>ูุงุชู ุงููุฏูุฑ:</b> <span style="direction:ltr;unicode-bidi:bidi-override;display:inline-block;text-align:left;">${formatPhoneNumber(d.directorPhone || '')}</span><br>
              <b>ุงุณู ุงููุณูุฑ ุงููุงูู:</b> ${d.financialName || ''}<br>
              <b>ูุงุชู ุงููุณูุฑ ุงููุงูู:</b> <span style="direction:ltr;unicode-bidi:bidi-override;display:inline-block;text-align:left;">${formatPhoneNumber(d.financialPhone || '')}</span><br>
              ${d.institutionFixedPhone ? `<b>ุฑูู ุงููุงุชู ุงูุซุงุจุช ูููุคุณุณุฉ:</b> <span style="direction:ltr;unicode-bidi:bidi-override;display:inline-block;text-align:left;">${formatFixedPhoneNumber(d.institutionFixedPhone || '')}</span><br>` : ''}
              <b>ุชุงุฑูุฎ ุงูุชุณุฌูู:</b> <span style="direction:ltr;unicode-bidi:bidi-override;display:inline-block;text-align:left;">${formatDateFromISO(d.date || '')}</span>${d.modificationDate ? `<br><b>ุชุงุฑูุฎ ุงูุชุนุฏูู:</b> <span style="direction:ltr;unicode-bidi:bidi-override;display:inline-block;text-align:left;">${formatDateFromISO(d.modificationDate || '')}</span>` : ''}
            </div>`,
          icon: "warning",
          showCancelButton: true,
          showDenyButton: true,
          confirmButtonText: "ุชุนุฏูู ุงูุจูุงูุงุช",
          denyButtonText: "ุญุฐู ุงูุชุณุฌูู",
          cancelButtonText: "ุฅุบูุงู",
          confirmButtonColor: "#FFAD29",
          denyButtonColor: "#dc3545"
        }).then((result) => {
          if (result.isConfirmed) {
            // ุนุฑุถ ุงูุงุณุชูุงุฑุฉ ูุน ุงูุจูุงูุงุช ููุชุนุฏูู
            showEditForm(empId, data, d);
          } else if (result.isDenied) {
            // ุญุฐู ุงูุชุณุฌูู
            deleteRegistration(empId);
          }
        });
        return; // ๐ฅ ูุง ูุนุฑุถ ุงูุงุณุชูุงุฑุฉ ุฅูุง ุนูุฏ ุงูุถุบุท ุนูู ุชุนุฏูู
      }

      // ๐ข ูู ุญุงูุฉ ุนุฏู ูุฌูุฏ ุชุณุฌูู ุณุงุจู โ ูุณูุญ ุจูุชุงุจุนุฉ ุงูุชุณุฌูู
      Swal.fire({
        title: "โ ุชู ุงูุชุญูู ุจูุฌุงุญ",
        html: `<b>ุงูุงุณู ูุงูููุจ:</b> ${escapeHtml(data.name)}<br><b>ุงูุฑุชุจุฉ:</b> ${escapeHtml(data.grade)}<br><b>ููุงู ุงูุนูู:</b> ${escapeHtml(data.place)}`,
        icon: "success",
        confirmButtonText: "ูุชุงุจุนุฉ ุงูุชุณุฌูู"
      }).then(() => showForm(empId, data));

    } catch (err) {
      Swal.close();
      Swal.fire("โ ุฎุทุฃ", "ุชุนุฐุฑ ุงูุชุญูู ูู ุงูุชุณุฌููุงุช ุงูุณุงุจูุฉ", "error");
      console.error("check_existing error:", err);
    }

  } catch (err) {
    Swal.close();
    Swal.fire("โ ุฎุทุฃ", "ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุจูุงูุงุช ุงูููุธููู", "error");
    console.error("Firebase error:", err);
  }
}


function escapeHtml(str){ return String(str || '').replace(/[&<>"'`=\/]/g, function(s){ return '&#' + s.charCodeAt(0) + ';'; }); }

// ุฏุงูุฉ ูุชุญููู ุงูุชุงุฑูุฎ ูู ุตูุบุฉ ISO ุฅูู ุตูุบุฉ "dd-MM-yyyy HH:mm:ss"
function formatDateFromISO(dateStr) {
  if (!dateStr) return 'ุบูุฑ ูุญุฏุฏ';
  
  try {
    let date;
    
    // ุงูุชุญูู ุฅุฐุง ูุงู ุงูุชุงุฑูุฎ ุจุตูุบุฉ ISO (ูุซู: 2025-11-14T12:17:26.000Z)
    if (dateStr.includes('T')) {
      date = new Date(dateStr);
    } else if (dateStr.includes('-') && dateStr.includes(' ')) {
      // ุฅุฐุง ูุงู ุจุตูุบุฉ "dd-MM-yyyy HH:mm:ss" ูุนูุฏู ููุง ูู
      return dateStr;
    } else {
      // ูุญุงููุฉ ุชุญูููู ูุชุงุฑูุฎ
      date = new Date(dateStr);
    }
    
    // ุงูุชุญูู ูู ุตุญุฉ ุงูุชุงุฑูุฎ
    if (isNaN(date.getTime())) {
      return dateStr;
    }
    
    // ุชุญููู ุงูุชุงุฑูุฎ ุฅูู ุตูุบุฉ "dd-MM-yyyy HH:mm:ss"
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');
    
    return `${hours}:${minutes}:${seconds} ll ${year}-${month}-${day}`;
  } catch (err) {
    return dateStr; // ูู ุญุงูุฉ ุงูุฎุทุฃุ ูุนูุฏ ุงูุชุงุฑูุฎ ุงูุฃุตูู
  }
}

/* ----- ุจูุงูุงุช ุงููุคุณุณุงุช ุญุณุจ ุงูุฏุงุฆุฑุฉ (ูุชูุณุท / ุซุงููู) ----- 
   ูููู ุชูุณูุน ูุฐุง ุงููุงุฆู ูุงุญููุง ุฃู ุฌูุจู ูู ููู ุฎุงุฑุฌู.
*/
window.institutionsByDaaira = {
  "ุชููุฑุช": {
    "ูุชูุณุท": [
      { name: "ูุชูุณุทุฉ ุณุนุฏ ุจู ุฃุจู ููุงุต ุชูุฑุช", code: "551201" },
      { name: "ูุชูุณุทุฉ ุงูุฅูุงู ุนูู ุชููุฑุช", code: "551202" },
      { name: "ูุชูุณุทุฉ ูุญูุฏ ุงูุฃููู ุงูุนููุฏู ุชูุฑุช", code: "551203" },
      { name: "ูุชูุณุทุฉ ุงูุดูุฎ ุงูููุฑุงูู ุชุจุณุจุณุช", code: "551204" },
      { name: "ูุชูุณุทุฉ ุจู ูุฏูุฉ ุงููุฏูู ุงููุฒูุฉ", code: "551205" },
      { name: "ูุชูุณุทุฉ ุนุจุฏ ุงูุญููุฏ ุจู ุจุงุฏูุณ ุชููุฑุช", code: "551206" },
      { name: "ูุชูุณุทุฉ ุญูุฒุฉ ุจู ุนุจุฏ ุงููุทูุจ ุงูุฒุงููุฉ ุงูุนุงุจุฏูุฉ", code: "551207" },
      { name: "ูุชูุณุทุฉ ูุตุฑุงุช ุญุดุงูู ุชุจุณุจุณุช", code: "551208" },
      { name: "ูุชูุณุทุฉ ุนูุณุงุช ุงูุฏูุฑ ุงูุจูุฌุฉ ุชุจุณุจุณุช", code: "551209" },
      { name: "ูุชูุณุทุฉ ุชุฌููู ูุญูุฏ ุนูู ุงูุตุญุฑุงุก ุงููุฒูุฉ", code: "551210" },
      { name: "ูุชูุณุทุฉ ุงุจู ุฑุดุฏ ุญู ุงูุนุฑููุจ ุชููุฑุช", code: "551211" },
      { name: "ูุชูุณุทุฉ ุฑุถุง ุญูุญู ุงูุฒุงููุฉ ุงูุนุงุจุฏูุฉ", code: "551212" },
      { name: "ูุชูุณุทุฉ ููุนุงุฏู ูุฎุฑ ุงูุฏูู ุงููุฒูุฉ", code: "551213" },
      { name: "ูุชูุณุทุฉ ุนุทุงูู ูุญูุฏ ุงูุตุบูุฑ ุณูุฏู ููุฏู ุงููุฒูุฉ", code: "551214" },
      { name: "ูุชูุณุทุฉ ูุญูุฏ ุนูุฑุงู ุจููููุฉ ุญู ุงูุฑูุงู ุชููุฑุช", code: "551215" },
      { name: "ูุชูุณุทุฉ ุนุจุฏ ุงููุคูู ุจู ุนูู ุงููุฒูุฉ", code: "551216" },
      { name: "ูุชูุณุทุฉ ุจู ุงูุฒุงูู ุนูู ุชุจุณุจุณุช", code: "551217" },
      { name: "ูุชูุณุทุฉ ุงูุจุดูุฑ ุงูุงุจุฑุงูููู ุชููุฑุช", code: "551218" },
      { name: "ูุชูุณุทุฉ ุญู 5 ุฌููููุฉ ุงูุฒุงููุฉ ุงูุนุงุจุฏูุฉ", code: "551219" },
      { name: "ูุชูุณุทุฉ ุจู ุญูุฒูุฉ ุนุจุฏ ุงููู ุนูู ุงูุตุญุฑุงุก 1 ุงููุฒูุฉ", code: "551220" },
      { name: "ูุชูุณุทุฉ ุจู ูููุฉ ูุญูุฏ ุงูุฒุงููุฉ ุงูุนุงุจุฏูุฉ", code: "551221" },
      { name: "ูุชูุณุทุฉ ุชูุฑูู ูุญูุฏ ุชููุฑุช", code: "551222" },
      { name: "ูุชูุณุทุฉ ุดุงูุด ูุญูุฏ ุชุจุณุจุณุช", code: "551223" },
      { name: "ูุชูุณุทุฉ ุงููุฌุงูุฏ ุงูุชุฌุงูู ุงูุตุงุฏู ุงููุฒูุฉ", code: "551224" },
      { name: "ูุชูุณุทุฉ ุฎุฑูุจู ูุญูุฏ ูุฎุถุฑ ุงููุฒูุฉ", code: "551225" },
      { name: "ูุชูุณุทุฉ ุงููุฌุงูุฏ ุณุจูุงู ุงูุนูุฏ ุชููุฑุช", code: "551226" },
      { name: "ูุชูุณุทุฉ ุฏูุนุฉ ุงูุทุงูุฑ ุชุจุณุจุณุช", code: "551227" },
      { name: "ูุชูุณุทุฉ ุจุฏูุฏุฉ ูุนูุฑ ุจู ุนูู ุงููุฒูุฉ", code: "551228" },
      { name: "ูุชูุณุทุฉ ุฏุงุดุฑ ุงูุญุงุฌ ุญู ุงููุณุชูุจู ุชููุฑุช", code: "551229" },
      { name: "ูุชูุณุทุฉ ุงููุฌุงูุฏ ุฑูุงุต ูุญูุฏ ุญู ุงููุณุชูุจู ุชููุฑุช", code: "551230" },
      { name: "ูุชูุณุทุฉ ุงููุฌุงูุฏ ุจููููุฉ ู ุงูุนูุฏุญู ุงููุณุชูุจู ุชููุฑุช", code: "551231" },
      { name: "ูุชูุณุทุฉ ุงููุฌุงูุฏ ุนูุงุฑู ุงูุณุงูุญุญู ุงููุณุชูุจู ุชููุฑุช", code: "551232" }
    ],
    "ุซุงููู": [
      { name: "ุซุงูููุฉ ุงูุฃููุฑ ุนุจุฏ ุงููุงุฏุฑ ุชููุฑุช", code: "551101" },
      { name: "ุซุงูููุฉ ุนุจุฏ ุงูุฑุญูุงู ุงูููุงูุจู ุชุจุณุจุณุช", code: "551102" },
      { name: "ุซุงูููุฉ ุงูุญุณู ุจู ุงูููุซู ุงููุฒูุฉ", code: "551103" },
      { name: "ุซุงูููุฉ ุงูุจุดูุฑ ุงูุงุจุฑุงูููู ุชุจุณุจุณุช", code: "551104" },
      { name: "ุซุงูููุฉ ููุงุฑู ุจููุฏูู ุงูุฒุงููุฉ ุงูุนุงุจุฏูุฉ", code: "551105" },
      { name: "ุซุงูููุฉ ุฃุจู ุจูุฑ ุจููุงูุฏ ุงููุฒูุฉ", code: "551106" },
      { name: "ุซุงูููุฉ ูุฒูุงุฑู ุชููุณู ุงูุฒุงููุฉ ุงูุนุงุจุฏูุฉ", code: "551107" },
      { name: "ุซุงูููุฉ ุจูุฎุงุฑู ุนุจุฏ ุงููุงูู ุงููุฒูุฉ", code: "551108" },
      { name: "ุซุงูููุฉ ุนุจูุฏุฉ ุนูู -ุญู ุงููุณุชูุจู - ุชููุฑุช", code: "551109" },
      { name: "ุซุงูููุฉ ูุณุบููู ู ุงูุตุงูุญ - ุญู ุงููุณุชูุจู", code: "551110" }
    ]
  },

  "ุงูุญุฌูุฑุฉ": {
    "ูุชูุณุท": [
      { name: "ูุชูุณุทุฉ ุงุจู ุณููุง ุงูุญุฌูุฑุฉ", code: "552201" },
      { name: "ูุชูุณุทุฉ ูุฎุถุงุฑู ูุฎุถุฑ ุงูุนุงููุฉ", code: "552202" },
      { name: "ูุชูุณุทุฉ ุฒูุงุจุฑู ูุณุนูุฏ ููุฑุงู ุงูุญุฌูุฑุฉ", code: "552203" },
      { name: "ูุชูุณุทุฉ ุงูุณุงูุญ ุจู ุนูุณู ูุญูุฏ ุงูุณุงูุญ ุงูุนุงููุฉ", code: "552204" },
      { name: "ูุชูุณุทุฉ ุจู ุดููุญุฉ ุญูุฒุฉ ุงูุญุฌูุฑุฉ", code: "552205" },
      { name: "ูุชูุณุทุฉ ุดูุบูู ุจุดูุฑ ุงูุดูุฉ -ุงูุนุงููุฉ-", code: "552206" },
      { name: "ุงููุฌุงูุฏ ุดุนูุจ ุงูุฃุฎุถุฑ ุงูุญุฌูุฑุฉ", code: "552206" }
    ],
    "ุซุงููู": [
      { name: "ุซุงูููุฉ ุทุงุฑู ุจู ุฒูุงุฏ ุงูุญุฌูุฑุฉ", code: "552101" },
      { name: "ุซุงูููุฉ ุจุณุงุณู ูุญูุฏ ุงูุตุบูุฑ ุงูุนุงููุฉ", code: "552102" },
      { name: "ุซุงูููุฉ ูุญุณููู ูุญูุฏ ุงูุญุฌูุฑุฉ", code: "552103" },
      { name: "ุซุงูููุฉ ุจุงูุถูุงู ูุญูุฏ ููุฑุงู ุงูุญุฌูุฑุฉ", code: "552104" }
    ]
  },

  "ุงูุทูุจุงุช": {
    "ูุชูุณุท": [
      { name: "ูุชูุณุทุฉ ุฃุญูุฏ ุฒุจุงูุฉ ุงูุทูุจุงุช", code: "553201" },
      { name: "ูุชูุณุทุฉ ููุณู ุจู ูุตูุฑ ุงููููุฑ", code: "553202" },
      { name: "ูุชูุณุทุฉ ุทุงุฑู ุจู ุฒูุงุฏ ุจู ูุงุตุฑ", code: "553203" },
      { name: "ูุชูุณุทุฉ ูุชุงุฑู ูุญูุฏ ุงูุฏูููุนู ุงูุทูุจุงุช", code: "553204" },
      { name: "ูุชูุณุทุฉ ุงูุนููู ูุญูุฏ ุงููุจูุฑ ุงูุทูุจุงุช", code: "553205" },
      { name: "ูุชูุณุทุฉ ูุนูุฑู ูุญูุฏ ุจู ูุงุตุฑ", code: "553206" },
      { name: "ูุชูุณุทุฉ ุงูุนูุฏ ุฒูุฑูุฑ ุงููููุฑ", code: "553207" },
      { name: "ูุชูุณุทุฉ ุจูุนุฌุงู ุฃุญูุฏ ุงูุฎุจูุฉ ุงูุทูุจุงุช", code: "553208" },
      { name: "ูุชูุณุทุฉ ุงููุฌุงูุฏ ุงูุฎุฐูุฑ ุฃุญูุฏ ุงููููุฑ", code: "553209" },
      { name: "ูุชูุณุทุฉ ุงููุฌุงูุฏ ุฑุงุจุญู ุงูุนูุฏ ุงููููุฑ", code: "553210" },
      { name: "ูุชูุณุทุฉ ุงููุฌุงูุฏ ุจูุงุฑู ุน ุงููุงุฏุฑ ุฏููููุนู ุงูุทูุจุงุช", code: "553211" }
    ],
    "ุซุงููู": [
      { name: "ุซุงูููุฉ ุงุจู ุฑุดูู ุงูููุฑูุงูู ุงูุทูุจุงุช", code: "553101" },
      { name: "ุซุงูููุฉ ุงููููุฑ - ุฏูุนุฉ ุนูู ุงููููุฑ", code: "553102" },
      { name: "ุซุงูููุฉ ุนุจูุฏ ุฃุญูุฏ ุจู ูุงุตุฑ", code: "553103" },
      { name: "ุซุงูููุฉ ุฒูููู ุงูุตุบูุฑ ุงูุฏููููุนู ุงูุทูุจุงุช", code: "553104" }
    ]
  },

  "ุงูููุงุฑูู": {
    "ูุชูุณุท": [
      { name: "ูุชูุณุทุฉ ุงููุฑุงุจู ุงูููุงุฑูู", code: "554201" },
      { name: "ูุชูุณุทุฉ ุทูุญู ูุณุนูุฏ ุณูุฏู ุณูููุงู", code: "554202" },
      { name: "ูุชูุณุทุฉ ุจูุญุงุฑุซ ูุญูุฏ ุงูุณุงูุญ ุณูุฏู ุณูููุงู", code: "554203" },
      { name: "ูุชูุณุทุฉ ุณููู ุงููุงุดูู ุงูุทูุจุงุช", code: "554204" },
      { name: "ูุชูุณุทุฉ ุงูุดููุฏ ุนุจุฏ ุงูุฑุญูุงู ููุชุงู ุงููุตูุฑ ุงูููุงุฑูู", code: "554205" },
      { name: "ูุชูุณุทุฉ ุงูุดููุฏ ุฃุญููุฏุฉ ุจูุญูุต ุงูููุงุฑูู", code: "554206" },
      { name: "ูุชูุณุทุฉ ุจุฑูุจูุฉ ุนุจุฏ ุงูุฑุฒุงู ุงูููุงุฑูู", code: "554207" },
      { name: "ูุชูุณุทุฉ ุงูุดููุฏ ุชูุงุณููู ุน ุงูุฑุญูุงู ููุฑูููุฑุฉ ุงูููุงุฑูู", code: "554208" }
    ],
    "ุซุงููู": [
      { name: "ุซุงูููุฉ ุฎุงูุฏ ุจู ุงููููุฏ ุงูููุงุฑูู", code: "554101" },
      { name: "ุซุงูููุฉ ุจู ุนูุฑ ุงูููู ุณูุฏู ุณูููุงู", code: "554102" },
      { name: "ุซุงูููุฉ ุนููุด ุณุนุฏูู ุงูููุงุฑูู", code: "554103" }
    ]
  },

  "ุชูุงุณูู": {
    "ูุชูุณุท": [
      { name: "ูุชูุณุทุฉ ุนูุฑ ุจู ุงูุฎุทุงุจ ุชูุงุณูู", code: "555201" },
      { name: "ูุชูุณุทุฉ ูููุงุชู ูุญูุฏ ุงูุณุงูุญ ุจูุฏุฉ ุนูุฑ", code: "555202" },
      { name: "ูุชูุณุทุฉ ุฃุจู ุจูุฑ ุงูุฑุงุฒู ุงูุจุญูุฑ ุชูุงุณูู", code: "555203" },
      { name: "ูุชูุณุทุฉ ูููู ูุญูุฏ ุงูุทูุจ ุณูุฏู ุนุงูุฑ ุชูุงุณูู", code: "555204" },
      { name: "ูุชูุณุทุฉ ูุนุฑูุฉ ูุฑุฏุงุด ุจูุฏุฉ ุนูุฑ", code: "555205" },
      { name: "ูุชูุณุทุฉ ูุญูุฏ ุงูุตุฏูู ุจู ูุญู ุญู ุงููุฏูุฉ ุชูุงุณูู", code: "555206" },
      { name: "ูุชูุณุทุฉ ุจุฑูุฉ ุนุจุฏ ุงูุฑุฒุงู ููู ุจูุฏุฉ ุนูุฑ", code: "555207" },
      { name: "ูุชูุณุทุฉ ุจุฏูุฏุฉ ุงูุณุงูุญ ุชููุงุญุช ุชูุงุณูู", code: "555208" },
      { name: "ูุชูุณุทุฉ ุน ุงุจู ุจุงุฏูุณ ููู ุจูุฏุฉ ุนูุฑ", code: "555209" }
    ],
    "ุซุงููู": [
      { name: "ุซุงูููุฉ ููุฏู ุฒูุฑูุง ุชูุงุณูู", code: "555101" },
      { name: "ุซุงูููุฉ ุงูุนูุฏ ุจู ุงูุตุญุฑุงูู ุจูุฏุฉ ุนูุฑ", code: "555102" },
      { name: "ุซุงูููุฉ ูููุฏุฑู ูุญูุฏ ุงูุนูุฏ ุชูุงุณูู", code: "555103" },
      { name: "ุซุงูููุฉ ุชุฌููู ูุญูุฏ ูุฎุถุฑ ุจูุฏุฉ ุนูุฑ", code: "555104" },
      { name: "ุซุงูููุฉ ูุงูู ุจู ูุจู ููู", code: "555105" }
    ]
  }
};

/* ----- ุฎุฑูุทุฉ ุงูุจูุฏูุงุช ุงูุฃุตููุฉ (ููุง ูู ููุฏู ุงูุณุงุจู) ----- */
window.baladiyaMap = {
  "ุชููุฑุช": ["ุชููุฑุช", "ุงููุฒูุฉ", "ุชุจุณุจุณุช", "ุงูุฒุงููุฉ ุงูุนุงุจุฏูุฉ"],
  "ุชูุงุณูู": ["ุชูุงุณูู", "ุจูุฏุฉ ุนูุฑ"],
  "ุงูููุงุฑูู": ["ุงูููุงุฑูู", "ุณูุฏู ุณูููุงู"],
  "ุงูุญุฌูุฑุฉ": ["ุงูุญุฌูุฑุฉ", "ุงูุนุงููุฉ"],
  "ุงูุทูุจุงุช": ["ุงูุทูุจุงุช", "ุงููููุฑ", "ุงุจู ูุงุตุฑ"]
};

// ูุชุบูุฑ ูุชุชุจุน ูุถุน ุงูุชุนุฏูู
let isEditMode = false;

function showForm(empId, data) {
  isEditMode = false;
  const container = document.getElementById("mainContainer");
  container.innerHTML = `
    <h2 style="margin-bottom:12px;">ุงุณุชูุงุฑุฉ ุงููุนูููุงุช ุงูุฎุงุตุฉ ุจุงููุคุณุณุฉ</h2>

    <div class="row">
      <div class="col"><input type="text" id="empIdField" value="${escapeHtml(empId)}" readonly></div>
      <div class="col"><input type="text" id="nameField" value="${escapeHtml(data.name || '')}" readonly></div>
    </div>

    <div class="row">
      <div class="col"><input type="text" id="gradeField" value="${escapeHtml(data.grade || '')}" readonly></div>
      <div class="col"><input type="text" id="placeField" value="${escapeHtml(data.place || '')}" readonly></div>
    </div>

    <select id="sifaField">
      <option value="">ุงุฎุชุฑ ุงูุตูุฉ</option>
      <option value="ูุฏูุฑ">ูุฏูุฑ</option>
      <option value="ูุฏูุฑ ูููู">ูุฏูุฑ ูููู</option>
    </select>

<div class="form-group" id="currentWorkDiv" style="display:none;">
  <label for="currentWorkField">ูุคุณุณุฉ ุงูุนูู ุงูุญุงููุฉ</label>
  <input type="text" id="currentWorkField" class="form-control" placeholder="ุฃุฏุฎู ุงุณู ุงููุคุณุณุฉ ุงูุชู ุชุนูู ุจูุง ุญุงููุง">
</div>


    <div class="row">
      <div class="col">
        <select id="levelField" onchange="onLevelOrDaairaChange()">
          <option value="">ุงุฎุชุฑ ุงูุทูุฑ</option>
          <option value="ุงุจุชุฏุงุฆู">ุงุจุชุฏุงุฆู</option>
          <option value="ูุชูุณุท">ูุชูุณุท</option>
          <option value="ุซุงููู">ุซุงููู</option>
        </select>
      </div>
      <div class="col">
        <select id="daairaField" onchange="onLevelOrDaairaChange(); updateBaladiya();">
          <option value="">ุงุฎุชุฑ ุงูุฏุงุฆุฑุฉ</option>
          <option value="ุชููุฑุช">ุชููุฑุช</option>
          <option value="ุชูุงุณูู">ุชูุงุณูู</option>
          <option value="ุงูููุงุฑูู">ุงูููุงุฑูู</option>
          <option value="ุงูุญุฌูุฑุฉ">ุงูุญุฌูุฑุฉ</option>
          <option value="ุงูุทูุจุงุช">ุงูุทูุจุงุช</option>
        </select>
      </div>
    </div>

    <select id="baladiyaField">
      <option value="">ุงุฎุชุฑ ุงูุจูุฏูุฉ</option>
    </select>

    <!-- ููุทูุฉ ุงุณู ุงููุคุณุณุฉ / ุณููู ุฏููุงูููู -->
    <div id="institutionArea">
      <!-- ุณูููุฃ ุฏููุงููููุงู -->
      <input type="text" id="institutionPlaceholder" value="" readonly style="display:none;">
    </div>

    <input type="text" id="institutionCodeField" placeholder="ุฑูุฒ ุงููุคุณุณุฉ" readonly style="display:none; margin-top:6px;">

    <input type="text" id="institutionEmailField" placeholder="ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูููุคุณุณุฉ (example123@gmail.com)" oninput="validateGmail(this)">

    <input type="text" id="phoneDirectorField" placeholder="ุฑูู ูุงุชู ุงููุฏูุฑ (10 ุฃุฑูุงู)" oninput="formatPhoneSimple(this)" dir="ltr">
    <input type="text" id="financialManagerField" placeholder="ุงุณู ูููุจ ุงููุณูุฑ ุงููุงูู">
    <input type="text" id="phoneFinancialField" placeholder="ุฑูู ูุงุชู ุงููุณูุฑ ุงููุงูู (10 ุฃุฑูุงู)" oninput="formatPhoneSimple(this)" dir="ltr">
    <input type="text" id="institutionFixedPhoneField" placeholder="ุฑูู ุงููุงุชู ุงูุซุงุจุช ูููุคุณุณุฉ (9 ุฃุฑูุงู: 000 00 00 00)" oninput="formatFixedPhone(this)" dir="ltr">

    <div class="small-note">ุชุญูู ูู ุฅุฏุฎุงู ุฌููุน ุงูุญููู ุงููุทููุจุฉ ุซู ุงุถุบุท ุชุณุฌูู</div>
    <button id="submitBtn" onclick="submitForm()">ุชุณุฌูู</button>
  `;

  // ุชููุฆุฉ ุงูุงุณุชูุงุฑุฉ
  initializeForm();
}

// ุฏุงูุฉ ูุชููุฆุฉ ุงูุงุณุชูุงุฑุฉ
function initializeForm() {
// ุจุนุฏ ุญูู ุงููููุฐุฌ
  const sifaField = document.getElementById("sifaField");
  if (sifaField) {
    // ุฅุฒุงูุฉ ุฃู event listeners ุณุงุจูุฉ ูุชุฌูุจ ุงูุชูุฑุงุฑ
    const newSifaField = sifaField.cloneNode(true);
    sifaField.parentNode.replaceChild(newSifaField, sifaField);
    
    // ุฅุถุงูุฉ event listener ุฌุฏูุฏ
document.getElementById("sifaField").addEventListener("change", function() {
  const currentWorkDiv = document.getElementById("currentWorkDiv");
      const currentWorkField = document.getElementById("currentWorkField");
      
  if (this.value === "ูุฏูุฑ ูููู") {
        // ุฅุธูุงุฑ ุญูู ูุคุณุณุฉ ุงูุนูู ุงูุญุงููุฉ
        if (currentWorkDiv) {
    currentWorkDiv.style.display = "block";
        }
  } else {
        // ุฅุฎูุงุก ุญูู ูุคุณุณุฉ ุงูุนูู ุงูุญุงููุฉ ูุชูุฑูุบู
        if (currentWorkDiv) {
    currentWorkDiv.style.display = "none";
        }
        if (currentWorkField) {
          currentWorkField.value = ""; // โ ุชูุฑูุบ ุงูุญูู ุนูุฏ ุงูุชุบููุฑ ูู "ูุฏูุฑ ูููู" ุฅูู "ูุฏูุฑ"
        }
  }
});
  }

  // ุนูุงุตุฑ ูุณุงุนุฏุฉ
  const baladiyaField = document.getElementById("baladiyaField");
  if (baladiyaField) {
    baladiyaField.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุจูุฏูุฉ</option>';
  }
}

// ุฏุงูุฉ ูุนุฑุถ ุงูุงุณุชูุงุฑุฉ ูู ูุถุน ุงูุชุนุฏูู
function showEditForm(empId, firebaseData, existingData) {
  isEditMode = true;
  const container = document.getElementById("mainContainer");
  container.innerHTML = `
    <h2 style="margin-bottom:12px;">ุชุนุฏูู ุจูุงูุงุช ุงูุชุณุฌูู</h2>

    <div class="row">
      <div class="col"><input type="text" id="empIdField" value="${escapeHtml(empId)}" readonly></div>
      <div class="col"><input type="text" id="nameField" value="${escapeHtml(firebaseData.name || '')}" readonly></div>
    </div>

    <div class="row">
      <div class="col"><input type="text" id="gradeField" value="${escapeHtml(firebaseData.grade || '')}" readonly></div>
      <div class="col"><input type="text" id="placeField" value="${escapeHtml(firebaseData.place || '')}" readonly></div>
    </div>

    <select id="sifaField">
      <option value="">ุงุฎุชุฑ ุงูุตูุฉ</option>
      <option value="ูุฏูุฑ">ูุฏูุฑ</option>
      <option value="ูุฏูุฑ ูููู">ูุฏูุฑ ูููู</option>
    </select>

    <div class="form-group" id="currentWorkDiv" style="display:none;">
      <label for="currentWorkField">ูุคุณุณุฉ ุงูุนูู ุงูุญุงููุฉ</label>
      <input type="text" id="currentWorkField" class="form-control" placeholder="ุฃุฏุฎู ุงุณู ุงููุคุณุณุฉ ุงูุชู ุชุนูู ุจูุง ุญุงููุง">
    </div>

    <div class="row">
      <div class="col">
        <select id="levelField" onchange="onLevelOrDaairaChange()">
          <option value="">ุงุฎุชุฑ ุงูุทูุฑ</option>
          <option value="ุงุจุชุฏุงุฆู">ุงุจุชุฏุงุฆู</option>
          <option value="ูุชูุณุท">ูุชูุณุท</option>
          <option value="ุซุงููู">ุซุงููู</option>
        </select>
      </div>
      <div class="col">
        <select id="daairaField" onchange="onLevelOrDaairaChange(); updateBaladiya();">
          <option value="">ุงุฎุชุฑ ุงูุฏุงุฆุฑุฉ</option>
          <option value="ุชููุฑุช">ุชููุฑุช</option>
          <option value="ุชูุงุณูู">ุชูุงุณูู</option>
          <option value="ุงูููุงุฑูู">ุงูููุงุฑูู</option>
          <option value="ุงูุญุฌูุฑุฉ">ุงูุญุฌูุฑุฉ</option>
          <option value="ุงูุทูุจุงุช">ุงูุทูุจุงุช</option>
        </select>
      </div>
    </div>

    <select id="baladiyaField">
      <option value="">ุงุฎุชุฑ ุงูุจูุฏูุฉ</option>
    </select>

    <div id="institutionArea">
      <input type="text" id="institutionPlaceholder" value="" readonly style="display:none;">
    </div>

    <input type="text" id="institutionCodeField" placeholder="ุฑูุฒ ุงููุคุณุณุฉ" readonly style="display:none; margin-top:6px;">

    <input type="text" id="institutionEmailField" placeholder="ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูููุคุณุณุฉ (example123@gmail.com)" oninput="validateGmail(this)">

    <input type="text" id="phoneDirectorField" placeholder="ุฑูู ูุงุชู ุงููุฏูุฑ (10 ุฃุฑูุงู)" oninput="formatPhoneSimple(this)" dir="ltr">
    <input type="text" id="financialManagerField" placeholder="ุงุณู ูููุจ ุงููุณูุฑ ุงููุงูู">
    <input type="text" id="phoneFinancialField" placeholder="ุฑูู ูุงุชู ุงููุณูุฑ ุงููุงูู (10 ุฃุฑูุงู)" oninput="formatPhoneSimple(this)" dir="ltr">
    <input type="text" id="institutionFixedPhoneField" placeholder="ุฑูู ุงููุงุชู ุงูุซุงุจุช ูููุคุณุณุฉ (9 ุฃุฑูุงู: 000 00 00 00)" oninput="formatFixedPhone(this)" dir="ltr">
    
    <div class="small-note">ููููู ุชุนุฏูู ุงูุจูุงูุงุช ุฃุฏูุงู (ุงูุญููู ุงููุธููุฉ ุบูุฑ ูุงุจูุฉ ููุชุนุฏูู)</div>
    <button id="submitBtn" onclick="submitForm()">ุญูุธ ุงูุชุนุฏููุงุช</button>
  `;
  
  // ุชููุฆุฉ ุงูุงุณุชูุงุฑุฉ
  initializeForm();
  
  // ุชุนุจุฆุฉ ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ
  setTimeout(() => {
    document.getElementById("sifaField").value = existingData.role || "";
    if (existingData.role === "ูุฏูุฑ ูููู") {
      document.getElementById("currentWorkDiv").style.display = "block";
      document.getElementById("currentWorkField").value = existingData.currentWork || "";
    }
    document.getElementById("levelField").value = existingData.level || "";
    document.getElementById("daairaField").value = existingData.daira || "";
    
    // ุชุญุฏูุซ ุงูุจูุฏูุงุช ูุงููุคุณุณุงุช
    updateBaladiya();
    setTimeout(() => {
      document.getElementById("baladiyaField").value = existingData.baladiya || "";
      onLevelOrDaairaChange();
      
      // ุชุนุจุฆุฉ ุงุณู ุงููุคุณุณุฉ ูุฑูุฒูุง
      setTimeout(() => {
        const level = existingData.level || "";
        if (level === "ุงุจุชุฏุงุฆู") {
          const linkedSelect = document.getElementById("linkedMiddleSelect");
          if (linkedSelect) {
            linkedSelect.value = existingData.schoolCode || "";
            linkedSelect.dispatchEvent(new Event('change'));
          }
        } else {
          const instSelect = document.getElementById("instSelect");
          if (instSelect) {
            instSelect.value = existingData.schoolCode || "";
            instSelect.dispatchEvent(new Event('change'));
          }
        }
        
        document.getElementById("institutionEmailField").value = existingData.email || "";
        document.getElementById("phoneDirectorField").value = formatPhoneNumber(existingData.directorPhone || "");
        document.getElementById("financialManagerField").value = existingData.financialName || "";
        document.getElementById("phoneFinancialField").value = formatPhoneNumber(existingData.financialPhone || "");
        document.getElementById("institutionFixedPhoneField").value = formatFixedPhoneNumber(existingData.institutionFixedPhone || "");
      }, 300);
    }, 200);
  }, 100);
}

/* ุนูุฏ ุชุบููุฑ ุงูุทูุฑ ุฃู ุงูุฏุงุฆุฑุฉ - ุชุญุฏูุซ ุณููู ุงุณู ุงููุคุณุณุฉ ูุงูููุงุฆู */
function onLevelOrDaairaChange() {
  const level = document.getElementById("levelField").value;
  const daaira = document.getElementById("daairaField").value;
  const area = document.getElementById("institutionArea");
  const codeField = document.getElementById("institutionCodeField");

  area.innerHTML = '';
  codeField.style.display = 'none';
  codeField.value = '';

  if (!level || !daaira) return;

  const insts = window.institutionsByDaaira[daaira] || { "ูุชูุณุท": [], "ุซุงููู": [] };

  if (level === 'ุงุจุชุฏุงุฆู') {
    // โ ุงูุขู: ูุง ูุถุน "ูุคุณุณุฉ ุงููุฃูู"ุ ุจู ูุถุน placeholder ููุท
    area.innerHTML = `
      <input type="text" id="instNamePrimary" placeholder="ุงุฎุชุฑ ุงููุชูุณุทุฉ ุงูุชุงุจุนุฉ ููุง ุงูุงุจุชุฏุงุฆูุฉ (ุงููุฃูู)" readonly>
      <select id="linkedMiddleSelect">
      <option value="">-- ุงุฎุชุฑ ุงููุชูุณุทุฉ ุงูุชุงุจุนุฉ ููุง ุงูุงุจุชุฏุงุฆูุฉ --</option>
      </select>
       <div style="font-size:12px;color:#444;margin-bottom:8px;">ุณูุธูุฑ ุฑูุฒ ุงููุคุณุณุฉ ุนูุฏ ุงูุฅุฎุชูุงุฑ:</div> 
    `;
    const linked = document.getElementById("linkedMiddleSelect");
    (insts["ูุชูุณุท"] || []).forEach(i => {
      const opt = document.createElement("option");
      opt.value = i.code;
      opt.text = `${i.name} โ ${i.code}`;
      linked.add(opt);
    });
    linked.addEventListener('change', (e) => {
      const codeField = document.getElementById("institutionCodeField");
      const instNamePrimary = document.getElementById("instNamePrimary");
      if (e.target.value) {
        const selectedOption = e.target.options[e.target.selectedIndex].text.split(' โ ')[0];
        instNamePrimary.value = selectedOption; // โ ุงุณู ุงููุชูุณุทุฉ ุงูุชุงุจุนุฉ
        codeField.style.display = '';
        codeField.value = e.target.value;       // โ ุฑูุฒ ุงููุชูุณุทุฉ
      } else {
        instNamePrimary.value = '';
        codeField.style.display = 'none';
        codeField.value = '';
      }
    });

  } else if (level === 'ูุชูุณุท' || level === 'ุซุงููู') {
    const list = insts[level] || [];
    area.innerHTML = `<select id="instSelect"><option value="">-- ุงุฎุชุฑ ${level} --</option></select>`;
    const select = document.getElementById("instSelect");
    list.forEach(i => {
      const opt = document.createElement("option");
      opt.value = i.code;
      opt.text = `${i.name} โ ${i.code}`;
      select.add(opt);
    });
    select.addEventListener('change', (e) => {
      const codeField = document.getElementById("institutionCodeField");
      if (e.target.value) {
        codeField.style.display = '';
        codeField.value = e.target.value;
      } else {
        codeField.style.display = 'none';
        codeField.value = '';
      }
    });
  }
}

function updateBaladiya() {
  const daaira = document.getElementById("daairaField").value;
  const baladiyaSelect = document.getElementById("baladiyaField");
  baladiyaSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุจูุฏูุฉ</option>';
  if (daaira && window.baladiyaMap[daaira]) {
    window.baladiyaMap[daaira].forEach(b => {
      const option = document.createElement("option");
      option.value = b; option.text = b;
      baladiyaSelect.add(option);
    });
  }
  // ุจุนุฏ ุชุบููุฑ ุงูุฏุงุฆุฑุฉุ ูุนูุฏ ุญุณุงุจ ุณููู ุงููุคุณูุณุฉ ุงุฐุง ุงูุทูุฑ ูุญุฏุฏ
  setTimeout(onLevelOrDaairaChange, 50);
}

/* ุชูุณูู ุฑูู ุงููุงุชู ุนูู ุดูู 00 00 00 00 00 */
function formatPhoneSimple(input) {
  // ุฅุฒุงูุฉ ูู ุดูุก ูุง ุนุฏุง ุงูุฃุฑูุงู
  let value = input.value.replace(/\D/g, '');
  
  // ุชุญุฏูุฏ ุฅูู 10 ุฃุฑูุงู
  value = value.slice(0, 10);
  
  // ุชูุณูู ุนูู ุดูู 00 00 00 00 00
  if (value.length > 0) {
    let formatted = '';
    for (let i = 0; i < value.length; i++) {
      if (i > 0 && i % 2 === 0) {
        formatted += ' ';
      }
      formatted += value[i];
    }
    input.value = formatted;
  } else {
    input.value = '';
  }
}

/* ุชูุณูู ุฑูู ุงููุงุชู ุงูุซุงุจุช ุนูู ุดูู 000 00 00 00 (9 ุฃุฑูุงู) */
function formatFixedPhone(input) {
  // ุฅุฒุงูุฉ ูู ุดูุก ูุง ุนุฏุง ุงูุฃุฑูุงู
  let value = input.value.replace(/\D/g, '');
  
  // ุชุญุฏูุฏ ุฅูู 9 ุฃุฑูุงู
  value = value.slice(0, 9);
  
  // ุชูุณูู ุนูู ุดูู 000 00 00 00
  if (value.length > 0) {
    let formatted = '';
    if (value.length >= 3) {
      formatted = value.slice(0, 3) + ' ';
      if (value.length >= 5) {
        formatted += value.slice(3, 5) + ' ';
        if (value.length >= 7) {
          formatted += value.slice(5, 7) + ' ';
          if (value.length >= 9) {
            formatted += value.slice(7, 9);
          } else {
            formatted += value.slice(5);
          }
        } else {
          formatted += value.slice(5);
        }
      } else {
        formatted += value.slice(3);
      }
    } else {
      formatted = value;
    }
    input.value = formatted;
  } else {
    input.value = '';
  }
}

/* ุฏุงูุฉ ูุชูุณูู ุฑูู ุงููุงุชู ูู ุฑูู ุนุงุฏู ุฅูู ุชูุณูู 00 00 00 00 00 */
function formatPhoneNumber(phone) {
  if (!phone) return '';
  // ุฅุฒุงูุฉ ุนูุงูุฉ ุงูุงูุชุจุงุณ ูู ุงูุจุฏุงูุฉ ุฅู ูุฌุฏุช (ูู Google Sheets)
  let phoneStr = String(phone).replace(/^'/, '');
  // ุฅุฒุงูุฉ ูู ุดูุก ูุง ุนุฏุง ุงูุฃุฑูุงู ูุงููุณุงูุงุช
  let value = phoneStr.replace(/[^\d\s]/g, '');
  // ุฅุฒุงูุฉ ุงููุณุงูุงุช ุซู ุฅุนุงุฏุฉ ุงูุชูุณูู
  value = value.replace(/\s/g, '');
  // ุชุญุฏูุฏ ุฅูู 10 ุฃุฑูุงู
  value = value.slice(0, 10);
  // ุชูุณูู ุนูู ุดูู 00 00 00 00 00
  if (value.length === 10) {
    return value.slice(0, 2) + ' ' + value.slice(2, 4) + ' ' + 
           value.slice(4, 6) + ' ' + value.slice(6, 8) + ' ' + value.slice(8, 10);
  } else if (value.length > 0) {
    // ุฅุฐุง ูุงู ุงูุฑูู ุฃูู ูู 10 ุฃุฑูุงูุ ููุณูู ููุง ูู
    let formatted = '';
    for (let i = 0; i < value.length; i++) {
      if (i > 0 && i % 2 === 0) {
        formatted += ' ';
      }
      formatted += value[i];
    }
    return formatted;
  }
  return '';
}

/* ุฏุงูุฉ ูุชูุณูู ุฑูู ุงููุงุชู ุงูุซุงุจุช ูู ุฑูู ุนุงุฏู ุฅูู ุชูุณูู 000 00 00 00 */
function formatFixedPhoneNumber(phone) {
  if (!phone) return '';
  // ุฅุฒุงูุฉ ุนูุงูุฉ ุงูุงูุชุจุงุณ ูู ุงูุจุฏุงูุฉ ุฅู ูุฌุฏุช (ูู Google Sheets)
  let phoneStr = String(phone).replace(/^'/, '');
  // ุฅุฒุงูุฉ ูู ุดูุก ูุง ุนุฏุง ุงูุฃุฑูุงู ูุงููุณุงูุงุช
  let value = phoneStr.replace(/[^\d\s]/g, '');
  // ุฅุฒุงูุฉ ุงููุณุงูุงุช ุซู ุฅุนุงุฏุฉ ุงูุชูุณูู
  value = value.replace(/\s/g, '');
  // ุชุญุฏูุฏ ุฅูู 9 ุฃุฑูุงู
  value = value.slice(0, 9);
  // ุชูุณูู ุนูู ุดูู 000 00 00 00
  if (value.length === 9) {
    return value.slice(0, 3) + ' ' + value.slice(3, 5) + ' ' + 
           value.slice(5, 7) + ' ' + value.slice(7, 9);
  } else if (value.length > 0) {
    // ุฅุฐุง ูุงู ุงูุฑูู ุฃูู ูู 9 ุฃุฑูุงูุ ููุณูู ุชุฏุฑูุฌูุงู
    let formatted = '';
    if (value.length >= 3) {
      formatted = value.slice(0, 3) + ' ';
      if (value.length >= 5) {
        formatted += value.slice(3, 5) + ' ';
        if (value.length >= 7) {
          formatted += value.slice(5, 7) + ' ';
          if (value.length >= 9) {
            formatted += value.slice(7, 9);
          } else {
            formatted += value.slice(7);
          }
        } else {
          formatted += value.slice(5);
        }
      } else {
        formatted += value.slice(3);
      }
    } else {
      formatted = value;
    }
    return formatted;
  }
  return '';
}       



/* ุชุญูู ูู ุงูุฅูููู */
function validateEmail(email) {
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(String(email).toLowerCase());
}

function validateGmail(input) {
  // ุฅุฒุงูุฉ ุงููุณุงูุงุช
  input.value = input.value.replace(/\s/g, '');
  
  // ููุน ุงูุญุฑูู ุงูุนุฑุจูุฉ
  input.value = input.value.replace(/[\u0600-\u06FF]/g, '');
  
  // ุฅุฌุจุงุฑ ุงููุต ุนูู ุญุฑูู ุตุบูุฑุฉ
  input.value = input.value.toLowerCase();
  
  // ุงูุณูุงุญ ููุท ุจู gmail
  if (!input.value.endsWith("@gmail.com") && input.value.length > 0) {
    input.setCustomValidity("ููุณูุญ ููุท ุจุญุณุงุจุงุช gmail");
  } else {
    input.setCustomValidity("");
  }
}


async function submitForm() {
  const submitBtn = document.getElementById("submitBtn");
  submitBtn.disabled = true;
  submitBtn.style.opacity = 0.6;

  const empId = document.getElementById("empIdField").value.trim();
  const name = document.getElementById("nameField").value.trim();
  const grade = document.getElementById("gradeField").value.trim();
  const place = document.getElementById("placeField").value.trim();
  const sifa = document.getElementById("sifaField").value.trim();
  const currentWork = document.getElementById("currentWorkField").value.trim();
  const level = document.getElementById("levelField").value.trim();
  const daaira = document.getElementById("daairaField").value.trim();
  const baladiya = document.getElementById("baladiyaField").value.trim();
  // โ ุงูุญุตูู ุนูู ุฃุฑูุงู ุงูููุงุชู ูุน ุงูุญูุงุธ ุนูู ุงูุชูุณูู 00 00 00 00 00
  const phoneDirector = document.getElementById("phoneDirectorField").value.trim();
  const financialManager = document.getElementById("financialManagerField").value.trim();
  const phoneFinancial = document.getElementById("phoneFinancialField").value.trim();
  const instEmail = document.getElementById("institutionEmailField").value.trim();
  const institutionFixedPhone = document.getElementById("institutionFixedPhoneField")?.value.trim() || "";
  

  // โ ุงููุคุณุณุฉ ุญุณุจ ุงูุทูุฑ
  let institutionName = "";
  let institutionCode = "";
  if (level === "ุงุจุชุฏุงุฆู") {
    institutionName = document.getElementById("instNamePrimary")?.value || "";
    institutionCode = document.getElementById("linkedMiddleSelect")?.value || "";
  } else {
    const sel = document.getElementById("instSelect");
    if (sel && sel.value) {
      institutionCode = sel.value;
      institutionName = sel.options[sel.selectedIndex].text.split(" โ ")[0];
    }
  }

  // ๐ฅ ุชุญูู ูู ุงูุญููู ุงููุทููุจุฉ + ุชูููู ุงููุงุฑุบ
  const requiredFields = [
    { id: "sifaField", value: sifa },
    { id: "levelField", value: level },
    { id: "daairaField", value: daaira },
    { id: "baladiyaField", value: baladiya },
    { id: "phoneDirectorField", value: phoneDirector },
    { id: "financialManagerField", value: financialManager },
    { id: "phoneFinancialField", value: phoneFinancial },
    { id: "institutionEmailField", value: instEmail },
  ];

  // ุฃุถู ุงูุญููู ุงูุฎุงุตุฉ ุจุงููุคุณุณุฉ
  if (level === "ุงุจุชุฏุงุฆู") {
    requiredFields.push({ id: "instNamePrimary", value: institutionName });
    requiredFields.push({ id: "linkedMiddleSelect", value: institutionCode });
  } else {
    requiredFields.push({ id: "instSelect", value: institutionCode });
  }

  let missing = false;
  requiredFields.forEach(f => {
    const el = document.getElementById(f.id);
    if (el && !f.value) {
      el.style.border = "2px solid red";
      missing = true;
      setTimeout(() => el.style.border = "", 3000); // ุจุนุฏ 3 ุซูุงูู ูุนูุฏ ูุทุจูุนุชู
    }
  });

  if (missing) {
    Swal.fire({
      icon: "warning",
      title: "ุชูุจูู",
      text: "ุงูุฑุฌุงุก ููุก ุฌููุน ุงูุญููู ุงููุทููุจุฉ ูุจู ุงูุชุณุฌูู",
    });
    submitBtn.disabled = false;
    submitBtn.style.opacity = 1;
    return;
  }

  // โ ุชุญูู ูู ุฃุฑูุงู ุงููุงุชู (ุฅุฒุงูุฉ ุงููุณุงูุงุช ููุชุญูู ูู ุงูุทูู)
  const phoneDirectorDigits = phoneDirector.replace(/\s/g, '');
  const phoneFinancialDigits = phoneFinancial.replace(/\s/g, '');
  if (phoneDirectorDigits.length !== 10 || phoneFinancialDigits.length !== 10) {
    Swal.fire("ุชูุจูู", "ุฃุฑูุงู ุงูููุงุชู ูุฌุจ ุฃู ุชุญุชูู ุนูู 10 ุฃุฑูุงู", "warning");
    submitBtn.disabled = false;
    submitBtn.style.opacity = 1;
    return;
  }

  // โ ุชุญูู ูู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
  if (!instEmail.endsWith("@gmail.com")) {
  Swal.fire("ุชูุจูู", "ููุณูุญ ููุท ุจุจุฑูุฏ gmail", "warning");
  submitBtn.disabled = false;
  submitBtn.style.opacity = 1;
  return;
}
if (/[ุฃ-ู]/.test(instEmail)) {
  Swal.fire("ุชูุจูู", "ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูุง ูุฌุจ ุฃู ูุญุชูู ุนูู ุญุฑูู ุนุฑุจูุฉ", "warning");
  submitBtn.disabled = false;
  submitBtn.style.opacity = 1;
  return;
}


  if (sifa === "ูุฏูุฑ ูููู" && !currentWork) {
  Swal.fire({
    icon: "warning",
    title: "ุชูุจูู",
    text: "ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณู ูุคุณุณุฉ ุงูุนูู ุงูุญุงููุฉ",
  });
  document.getElementById("currentWorkField").style.border = "2px solid red";
  setTimeout(() => document.getElementById("currentWorkField").style.border = "", 3000);
  submitBtn.disabled = false;
  submitBtn.style.opacity = 1;
  return;
}


  // ๐ข ุงูุขู ุชุงุจุน ุจุงูู ุงูููุฏ (ุฅุฑุณุงู ุงูุจูุงูุงุช ุนุจุฑ fetch ููุง ูู ููุฏู ุงูุฃุตูู)...


  // โ ุฅุนุฏุงุฏ ุงูุจูุงูุงุช ูุน action=register ุฃู update
  // โ๏ธ ููุงุญุธุฉ ูููุฉ: ูุฌุจ ุฃู ูุฏุนู ุณูุฑูุจุช Google Apps action="update" ูุชุญุฏูุซ ุงูุจูุงูุงุช
  // ุฅุฐุง ูู ููู ูุฏุนููุงูุ ุณุชุญุชุงุฌ ุฅูู ุฅุถุงูุฉ ูุนุงูุฌุฉ update ูู ุงูุณูุฑูุจุช
  const params = new URLSearchParams();
  
  params.append("action", isEditMode ? "update" : "register"); // โ ุงุณุชุฎุฏุงู update ูู ูุถุน ุงูุชุนุฏูู
  params.append("empId", empId);
  params.append("name", name);
  params.append("grade", grade);
  params.append("place", place);
  params.append("role", sifa); // โ ุจุฏู sifa
  params.append("level", level);
  params.append("daira", daaira); // โ ุจุฏู daaira
  params.append("baladiya", baladiya);
  params.append("school", institutionName); // โ ุจุฏู institutionName
  params.append("schoolCode", institutionCode); // โ ุจุฏู institutionCode
  params.append("directorPhone", phoneDirector); // โ ุจุฏู phoneDirector
  params.append("financialName", financialManager); // โ ุจุฏู financialManager
  params.append("financialPhone", phoneFinancial); // โ ุจุฏู phoneFinancial
  params.append("email", instEmail); // โ ุจุฏู instEmail
  params.append("currentWork", currentWork);
  params.append("institutionFixedPhone", institutionFixedPhone); // โ ุฑูู ุงููุงุชู ุงูุซุงุจุช ูููุคุณุณุฉ
  
  // โ ุฅุถุงูุฉ ุชุงุฑูุฎ ุงูุชุนุฏูู ููุท ูู ูุถุน ุงูุชุนุฏูู
  if (isEditMode) {
    const now = new Date();
    const day = String(now.getDate()).padStart(2, '0');
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const year = now.getFullYear();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    const modificationDate = `${hours}:${minutes}:${seconds} ll ${year}-${month}-${day}`;
    params.append("modificationDate", modificationDate);
  }

  Swal.fire({ title: isEditMode ? 'ุฌุงุฑู ุญูุธ ุงูุชุนุฏููุงุช...' : 'ุฌุงุฑู ุชุณุฌูู ุงูุจูุงูุงุช...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

  try {
    const res = await fetch(scriptURL, {
      method: "POST",
      body: params
    });
    const data = await res.json();

    // ุชุณุฌูู ุงูุงุณุชุฌุงุจุฉ ููุชุดุฎูุต
    console.log("Response from server:", data);
    console.log("Is edit mode:", isEditMode);
    console.log("Action sent:", isEditMode ? "update" : "register");

if (data.result === "success") {
  Swal.fire({
    title: isEditMode ? "โ ุชู ุญูุธ ุงูุชุนุฏููุงุช ุจูุฌุงุญ" : "โ ุชู ุงูุชุณุฌูู ุจูุฌุงุญ",
    text: isEditMode ? "ุชู ุชุญุฏูุซ ุจูุงูุงุชู ูู ูุงุนุฏุฉ ุจูุงูุงุช ูุตูุญุฉ ุชุณููุฑ ูููุงุช ุงููุณุชุฎุฏููู ุจูุฌุงุญ" : "ุชู ุชุณุฌูู ุจูุงูุงุชู ูู ูุงุนุฏุฉ ุจูุงูุงุช ูุตูุญุฉ ุชุณููุฑ ูููุงุช ุงููุณุชุฎุฏููู ุจูุฌุงุญ",
    icon: "success",
    confirmButtonText: "ุฅุบูุงู"
  }).then(() => {
    location.reload(); // ุนูุฏ ุงูุฅุบูุงู ูุนูุฏ ุชุญููู ุงูุตูุญุฉ ููุท
  });

} else if (data.result === "exists") {
  const d = data.data || {};
  
  // ููุฌููุฒ ุงููุต ุงูุฎุงุต ุจูุคุณุณุฉ ุงูุนูู ุงูุญุงููุฉ ููุท ุฅุฐุง ูุงูุช ุงูุตูุฉ "ูุฏูุฑ ูููู"
  const currentWorkLine = (d.role === "ูุฏูุฑ ูููู" && d.currentWork)
    ? `<b>ูุคุณุณุฉ ุงูุนูู ุงูุญุงููุฉ:</b> ${d.currentWork}<br>`
    : "";

  Swal.fire({
    title: "โ๏ธ ุงูุชุณุฌูู ููุฌูุฏ ูุณุจููุง",
    html: `
      <div style="text-align:right;direction:rtl;font-family:'Cairo',sans-serif;">
        <b>ุฑูู ุงูุชุนุฑูู:</b> ${d.empId || ''}<br>
        <b>ุงูุงุณู ูุงูููุจ:</b> ${d.name || ''}<br>
        <b>ุงูุฑุชุจุฉ:</b> ${d.grade || ''}<br>
        <b>ูุคุณุณุฉ ุงูุนูู ุงูุฃุตููุฉ:</b> ${d.place || ''}<br>
        <b>ุงูุตูุฉ:</b> ${d.role || ''}<br>
        ${currentWorkLine}
        <b>ุงูุทูุฑ:</b> ${d.level || ''}<br>
        <b>ุงูุฏุงุฆุฑุฉ:</b> ${d.daira || ''}<br>
        <b>ุงูุจูุฏูุฉ:</b> ${d.baladiya || ''}<br>
        <b>ุงุณู ุงููุคุณุณุฉ:</b> ${d.school || ''}<br>
        <b>ุฑูุฒ ุงููุคุณุณุฉ:</b> ${d.schoolCode || ''}<br>
        <b>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู:</b> ${d.email || ''}<br>
        <b>ูุงุชู ุงููุฏูุฑ:</b> ${formatPhoneNumber(d.directorPhone || '')}<br>  
        <b>ุงุณู ุงููุณูุฑ ุงููุงูู:</b> ${d.financialName || ''}<br>
        <b>ูุงุชู ุงููุณูุฑ ุงููุงูู:</b> ${formatPhoneNumber(d.financialPhone || '')}<br>
        ${d.institutionFixedPhone ? `<b>ุฑูู ุงููุงุชู ุงูุซุงุจุช ูููุคุณุณุฉ:</b> <span style="direction:ltr;unicode-bidi:bidi-override;display:inline-block;text-align:left;">${formatFixedPhoneNumber(d.institutionFixedPhone || '')}</span><br>` : ''}
        <b>ุชุงุฑูุฎ ุงูุชุณุฌูู:</b> <span style="direction:ltr;unicode-bidi:bidi-override;display:inline-block;text-align:left;">${formatDateFromISO(d.date || '')}</span>${d.modificationDate ? `<br><b>ุชุงุฑูุฎ ุงูุชุนุฏูู:</b> <span style="direction:ltr;unicode-bidi:bidi-override;display:inline-block;text-align:left;">${formatDateFromISO(d.modificationDate || '')}</span>` : ''}
      </div>
    `,
    icon: "warning",
    confirmButtonText: "ุฅุบูุงู"
  }).then(() => location.reload());

} else if (data.result === "email_exists") {
  Swal.fire({
    icon: "warning",
    title: "โ๏ธ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูุณุชุนูู",
    text: "ูุฐุง ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูุณุฌู ูุณุจููุง. ูุฑุฌู ุงุณุชุฎุฏุงู ุจุฑูุฏ ุขุฎุฑ.",
    confirmButtonText: "ุญุณููุง"
  });

  // โ ุฅุนุงุฏุฉ ุชูุนูู ุฒุฑ ุงูุชุณุฌูู ุจุนุฏ ุงูุชุญุฐูุฑ
  submitBtn.disabled = false;
  submitBtn.style.opacity = 1;



} else if (data.result === "phone_exists") {
  Swal.fire({
    icon: "warning",
    title: "โ๏ธ ุฑูู ูุงุชู ุงููุฏูุฑ ูุณุชุนูู",
    text: "ุฑูู ูุงุชู ุงููุฏูุฑ ูุณุฌู ูุณุจููุง. ูุฑุฌู ุงูุชุญูู ูู ุงูุฑูู.",
    confirmButtonText: "ุญุณููุง"
  });

  // โ ุฅุนุงุฏุฉ ุชูุนูู ุฒุฑ ุงูุชุณุฌูู ุจุนุฏ ุงูุชุญุฐูุฑ
  submitBtn.disabled = false;
  submitBtn.style.opacity = 1;




} else {
  // ุนุฑุถ ุชูุงุตูู ุงูุฎุทุฃ ูููุณุงุนุฏุฉ ูู ุงูุชุดุฎูุต
  const errorMsg = data.message || data.error || "ุชุนุฐุฑ ุฅุฑุณุงู ุงูุจูุงูุงุช";
  console.error("Error response:", data);
  Swal.fire({
    icon: "error",
    title: "โ ุฎุทุฃ",
    text: errorMsg + (isEditMode ? "\n\nููุงุญุธุฉ: ุชุฃูุฏ ูู ุฃู ุงูุณูุฑูุจุช ูุฏุนู action='update'" : ""),
    footer: isEditMode ? "ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉุ ูุฏ ุชุญุชุงุฌ ุฅูู ุฅุถุงูุฉ ุฏุนู action='update' ูู ุณูุฑูุจุช Google Apps" : ""
  });
  submitBtn.disabled = false;
  submitBtn.style.opacity = 1;
}


  } catch (error) {
    console.error("Fetch error:", error);
    Swal.fire({
      icon: "error",
      title: "โ ุฎุทุฃ",
      text: "ูุดู ุงูุงุชุตุงู ุจุฎุฏูุฉ ุงูุชุณุฌูู: " + error.message,
      footer: isEditMode ? "ุชุฃูุฏ ูู ูุชุญ Console (F12) ูุฑุคูุฉ ุชูุงุตูู ุงูุฎุทุฃ" : ""
    });
    submitBtn.disabled = false; 
    submitBtn.style.opacity = 1;
  }
}

// ุฏุงูุฉ ุญุฐู ุงูุชุณุฌูู ูู Google Sheet
async function deleteRegistration(empId) {
  // ุทูุจ ุชุฃููุฏ ูู ุงููุณุชุฎุฏู ูุจู ุงูุญุฐู
  const confirmResult = await Swal.fire({
    title: "โ๏ธ ุชุฃููุฏ ุงูุญุฐู",
    text: "ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุชุณุฌููุ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐู ุงูุนูููุฉ.",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "ูุนูุ ุงุญุฐู",
    cancelButtonText: "ุฅูุบุงุก",
    confirmButtonColor: "#dc3545",
    cancelButtonColor: "#6c757d"
  });

  if (!confirmResult.isConfirmed) {
    return; // ุงููุณุชุฎุฏู ุฃูุบู ุงูุนูููุฉ
  }

  Swal.fire({ 
    title: 'ุฌุงุฑู ุญุฐู ุงูุชุณุฌูู...', 
    allowOutsideClick: false, 
    didOpen: () => Swal.showLoading() 
  });

  try {
    const params = new URLSearchParams();
    params.append("action", "delete");
    params.append("empId", empId);

    const res = await fetch(scriptURL, {
      method: "POST",
      body: params
    });

    const data = await res.json();

    if (data.result === "success") {
      Swal.fire({
        title: "โ ุชู ุงูุญุฐู ุจูุฌุงุญ",
        text: "ุชู ุญุฐู ุงูุชุณุฌูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ",
        icon: "success",
        confirmButtonText: "ุญุณููุง"
      }).then(() => {
        location.reload(); // ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ุจุนุฏ ุงูุญุฐู
      });
    } else if (data.result === "not_found") {
      Swal.fire({
        title: "โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุชุณุฌูู",
        text: "ุงูุชุณุฌูู ุบูุฑ ููุฌูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช",
        icon: "warning",
        confirmButtonText: "ุญุณููุง"
      });
    } else {
      const errorMsg = data.message || data.error || "ุชุนุฐุฑ ุญุฐู ุงูุชุณุฌูู";
      Swal.fire({
        icon: "error",
        title: "โ ุฎุทุฃ",
        text: errorMsg,
        confirmButtonText: "ุญุณููุง"
      });
    }
  } catch (error) {
    console.error("Delete error:", error);
    Swal.fire({
      icon: "error",
      title: "โ ุฎุทุฃ",
      text: "ูุดู ุงูุงุชุตุงู ุจุฎุฏูุฉ ุงูุญุฐู: " + error.message,
      confirmButtonText: "ุญุณููุง"
    });
  }
}    

 // ๐ ุชุญูู ูู ูุชุญ ูุบูู ุงูุชุณุฌูู ูู ููุง
  const registrationOpen = true; // โ ุบููุฑ ุฅูู true ุนูุฏ ุงููุชุญ

  window.onload = function() {
    const container = document.querySelector(".container");
    const empInput = document.getElementById("empId");
    const checkBtn = container.querySelector("button");

    if (!registrationOpen) {
      // ุฅุฎูุงุก ุญูู ุงูุฅุฏุฎุงู ูุฒุฑ ุงูุชุญูู
      empInput.style.display = "none";
      checkBtn.style.display = "none";

      // ุฅุถุงูุฉ ุฑุณุงูุฉ ุงูุฅุบูุงู
      const msg = document.createElement("div");
      msg.innerHTML = `
        <div style="
          background: #f8d7da;
          color: #721c24;
          border: 1px solid #f5c6cb;
          border-radius: 10px;
          padding: 15px;
          margin-top: 0px;
           margin-bottom: 20px;
          font-size: 20px;
          font-weight: 600;">
           ุงูุชุณุฌูู ูุบูู ุญุงูููุง<br>ุณูุชู ูุชุญ ุงููููุน ูุฑูุจุง...
        </div>`;
      container.appendChild(msg);
    }
  };   

</script>
</body>
</html>

